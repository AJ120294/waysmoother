<!DOCTYPE html>
<html>
<head>
    <title>Directions</title>
    <style>
        .map {
            height: 400px;
            width: 600px;
            border: 1px solid black;
            margin-bottom: 20px;
        }
    </style>
    <script>
        function calculateDepartureTime(index) {
            // Get the visit time for the current route
            var visitTimeInput = document.getElementById(`visit_time_${index}`);
            var visitTime = parseInt(visitTimeInput.value) || 1; // Default to 1 hour if not set

            // Get the arrival time from the previous route
            var arrivalTimeInput = document.getElementById(`arrival_time_${index}`);
            var arrivalTime = new Date(`1970-01-01T${arrivalTimeInput.value}:00`); // Parse time

            // Calculate the new departure time
            arrivalTime.setHours(arrivalTime.getHours() + visitTime);

            // Update the departure time field for the next route
            var departureTimeInput = document.getElementById(`departure_time_${index}`);
            departureTimeInput.value = arrivalTime.toTimeString().split(' ')[0];
        }
    </script>
</head>
<body>
    <h1>Daily Activity Plan</h1>
    {% for schedule in all_routes %}
    <h2>Route {{ loop.index }}</h2>
    <table border="1">
        <thead>
            <tr>
                <th>From</th>
                <th>To</th>
                <th>Departure Time</th>
                <th>Arrival Time</th>
                <th>Estimated Travel Time</th>
            </tr>
        </thead>
        <tbody>
            {% for leg in schedule %}
            <tr>
                <td>{{ leg.origin }}</td>
                <td>{{ leg.destination }}</td>
                <td>{{ leg.departure_time }}</td>
                <td><input type="text" id="arrival_time_{{ loop.parent.loop.index }}" value="{{ leg.arrival_time }}" readonly></td>
                <td>{{ leg.estimated_travel_time }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div>
        <label for="visit_time_{{ loop.index }}">Visit Time:</label>
        <input type="number" id="visit_time_{{ loop.index }}" name="visit_time_{{ loop.index }}" value="1" min="0">
        <span> hour(s)</span><br><br>
        <label for="departure_time_{{ loop.index }}">Departure Time:</label>
        <input type="text" id="departure_time_{{ loop.index }}" readonly><br><br>
        <button type="button" onclick="calculateDepartureTime({{ loop.index }})">Calculate Time</button>
    </div>

    <div id="map{{ loop.index }}" class="map"></div>
    {% endfor %}

    <script>
        function initMaps() {
            {% for schedule in all_routes %}
            var map{{ loop.index }} = new google.maps.Map(document.getElementById('map{{ loop.index }}'), {
                center: {lat: -36.8485, lng: 174.7633}, // Auckland coordinates
                zoom: 12
            });
            var directionsService{{ loop.index }} = new google.maps.DirectionsService();
            var directionsRenderer{{ loop.index }} = new google.maps.DirectionsRenderer();
            directionsRenderer{{ loop.index }}.setMap(map{{ loop.index }});

            var origin = '{{ schedule[0]["origin"] }}';
            var destination = '{{ schedule[-1]["destination"] }}';
            var waypoints = [];

            var request = {
                origin: origin,
                destination: destination,
                waypoints: waypoints,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService{{ loop.index }}.route(request, function(result, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    directionsRenderer{{ loop.index }}.setDirections(result);
                } else {
                    alert('Directions request failed due to ' + status);
                }
            });
            {% endfor %}
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlCG_B-dTqzrexzWxe8D8wyJ24UmtCf-c&callback=initMaps" async defer></script>
</body>
</html>
